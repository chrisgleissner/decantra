name: Build Decantra

on:
  push:
    branches:
      - "**"
    tags:
      - "*"
  pull_request:
    types:
      - opened
      - reopened
      - ready_for_review
    paths-ignore:
      - "**.md"
      - "doc/**"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
  workflow_dispatch:
    inputs:
      run_android_build:
        description: "Run Android build"
        required: false
        default: true
        type: boolean
      run_ios_build:
        description: "Run iOS build"
        required: false
        default: true
        type: boolean
      build_debug_apk:
        description: "Build Debug APK (slow, skip by default)"
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UNITY_VERSION: "6000.3.5f2"

jobs:
  check-license:
    name: Check Unity license secrets
    runs-on: ubuntu-latest
    outputs:
      is_unity_license_set: ${{ steps.check.outputs.is_unity_license_set }}
    steps:
      - name: Detect Unity license secrets
        id: check
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          if [[ -n "${UNITY_LICENSE}" && -n "${UNITY_EMAIL}" && -n "${UNITY_PASSWORD}" ]]; then
            echo "is_unity_license_set=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_unity_license_set=false" >> "$GITHUB_OUTPUT"
          fi

  solvability:
    name: Solvability 1..1000 (deterministic artifact)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Regenerate solvability artifact and run gates
        env:
          DECANTRA_EXPECTED_LEVELS: "1000"
        run: |
          ./build --generate-solutions --skip-tests --skip-build

      - name: Verify solvability artifact is up to date
        run: |
          git diff --exit-code -- solver-solutions-debug.txt

      - name: Remove solvability outputs after assertion
        if: always()
        run: |
          rm -f solver-solutions-debug.txt
          rm -f solver-solutions-debug-sinks.txt
          rm -f doc/sink-bottles-levels-1-1000.csv

  # ============================================================================
  # TIER 1: Tests
  # ============================================================================
  test:
    name: Unity tests (EditMode + PlayMode)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: check-license
    if: needs.check-license.outputs.is_unity_license_set == 'true'
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-android-${{ hashFiles('Packages/manifest.json', 'Packages/packages-lock.json') }}

      - name: Run PlayMode tests
        uses: game-ci/unity-test-runner@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: playmode

      - name: Run EditMode tests
        uses: game-ci/unity-test-runner@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: editmode
          customParameters: >
            -enableCodeCoverage
            -coverageResultsPath Coverage
            -coverageOptions "generateAdditionalMetrics;assemblyFilters:+Decantra.Domain;dontClear"

      - name: Upload code coverage artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: Decantra-Coverage
          path: Coverage/**

  # ============================================================================
  # TIER 2: Android build
  # ============================================================================
  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [check-license, test, solvability]
    if: |
      needs.check-license.outputs.is_unity_license_set == 'true' &&
      needs.test.result == 'success' &&
      needs.solvability.result == 'success' &&
      (
        github.event_name == 'push' ||
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_android_build == 'true')
      )
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    steps:
      - name: Free disk space
        run: |
          echo "::group::Disk usage before cleanup"
          df -h /
          echo "::endgroup::"
          sudo rm -rf /usr/local/lib/android/sdk /usr/share/dotnet /usr/local/share/boost /opt/ghc /usr/local/graalvm /usr/local/share/powershell /usr/local/share/chromium /usr/local/lib/node_modules || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          echo "::group::Disk usage after cleanup"
          df -h /
          echo "::endgroup::"

      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Prepare keystore (optional)
        id: keystore
        env:
          KEYSTORE_STORE_FILE: ${{ secrets.KEYSTORE_STORE_FILE || secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_STORE_PASSWORD: ${{ secrets.KEYSTORE_STORE_PASSWORD || secrets.ANDROID_KEYSTORE_PASS }}
          KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS || secrets.ANDROID_KEYALIAS_NAME }}
          KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD || secrets.ANDROID_KEYALIAS_PASS }}
        run: |
          HAS_KEYSTORE=false
          if [[ -n "$KEYSTORE_STORE_FILE" ]]; then
            if [[ -f "$KEYSTORE_STORE_FILE" ]]; then
              echo "Using keystore at $KEYSTORE_STORE_FILE"
            else
              mkdir -p "$GITHUB_WORKSPACE/.ci"
              decode_target_rel=".ci/decantra-release.keystore"
              decode_target_abs="$GITHUB_WORKSPACE/$decode_target_rel"
              printf '%s' "$KEYSTORE_STORE_FILE" | base64 -d > "$decode_target_abs" 2>/dev/null || true
              if [[ -s "$decode_target_abs" ]]; then
                KEYSTORE_STORE_FILE="$decode_target_rel"
                echo "Decoded keystore secret to $KEYSTORE_STORE_FILE"
              else
                echo "Keystore secret present but could not decode to file; skipping custom keystore."
                KEYSTORE_STORE_FILE=""
              fi
            fi
          fi

          if [[ -n "$KEYSTORE_STORE_FILE" && -f "$KEYSTORE_STORE_FILE" && -n "$KEYSTORE_STORE_PASSWORD" && -n "$KEYSTORE_KEY_ALIAS" ]]; then
            HAS_KEYSTORE=true
            echo "KEYSTORE_STORE_FILE=$KEYSTORE_STORE_FILE" >> "$GITHUB_ENV"
            echo "KEYSTORE_STORE_PASSWORD=$KEYSTORE_STORE_PASSWORD" >> "$GITHUB_ENV"
            echo "KEYSTORE_KEY_PASSWORD=$KEYSTORE_KEY_PASSWORD" >> "$GITHUB_ENV"
            echo "KEYSTORE_KEY_ALIAS=$KEYSTORE_KEY_ALIAS" >> "$GITHUB_ENV"
          else
            echo "Keystore secrets missing or incomplete; proceeding without custom signing."
          fi

          echo "HAS_KEYSTORE=$HAS_KEYSTORE" >> "$GITHUB_ENV"
          echo "has_keystore=$HAS_KEYSTORE" >> "$GITHUB_OUTPUT"
          echo "keystore_store_file=$KEYSTORE_STORE_FILE" >> "$GITHUB_OUTPUT"
          echo "keystore_store_password=$KEYSTORE_STORE_PASSWORD" >> "$GITHUB_OUTPUT"
          echo "keystore_key_alias=$KEYSTORE_KEY_ALIAS" >> "$GITHUB_OUTPUT"
          echo "keystore_key_password=$KEYSTORE_KEY_PASSWORD" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Resolve artifact versioning
      # ------------------------------------------------------------
      - name: Resolve artifact versioning
        id: versioning
        run: |
          set -euo pipefail
          git fetch --tags --force --prune --prune-tags || true

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            artifact_version="${GITHUB_REF_NAME}"
          else
            base_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
            if [[ -z "${base_tag}" ]]; then
              base_tag="0.0.0"
            fi

            short_sha="$(git rev-parse --short=8 HEAD)"
            artifact_version="${base_tag}-${short_sha}"
          fi

          if [[ -z "${artifact_version}" ]]; then
            artifact_version="0.0.0"
          fi

          run_number="${GITHUB_RUN_NUMBER}"
          run_attempt="${GITHUB_RUN_ATTEMPT:-1}"

          version_code="$((1000 + run_number * 10 + run_attempt - 1))"

          if (( version_code < 1 || version_code > 2147483647 )); then
            echo "Computed VERSION_CODE ${version_code} is out of Android range." >&2
            exit 1
          fi

          echo "ARTIFACT_VERSION=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_NAME=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_CODE=${version_code}" >> "$GITHUB_ENV"
          echo "artifact_version=${artifact_version}" >> "$GITHUB_OUTPUT"
          echo "version_name=${artifact_version}" >> "$GITHUB_OUTPUT"
          echo "version_code=${version_code}" >> "$GITHUB_OUTPUT"

          echo "Resolved ARTIFACT_VERSION=${artifact_version}"
          echo "Resolved VERSION_CODE=${version_code}"

      # ------------------------------------------------------------
      # Build release artifacts
      # ------------------------------------------------------------
      - name: Build Android (release)
        uses: game-ci/unity-builder@v4
        env:
          KEYSTORE_STORE_FILE: ${{ steps.keystore.outputs.keystore_store_file }}
          KEYSTORE_STORE_PASSWORD: ${{ steps.keystore.outputs.keystore_store_password }}
          KEYSTORE_KEY_ALIAS: ${{ steps.keystore.outputs.keystore_key_alias }}
          KEYSTORE_KEY_PASSWORD: ${{ steps.keystore.outputs.keystore_key_password }}
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.AndroidBuild.BuildReleaseApk
          versioning: None
          customParameters: >
            -buildPath Builds/Android/decantra-${{ steps.versioning.outputs.artifact_version }}-android.apk
            -versionName ${{ steps.versioning.outputs.version_name }}
            -versionCode ${{ steps.versioning.outputs.version_code }}
          androidKeystoreName: ${{ steps.keystore.outputs.keystore_store_file }}
          androidKeystorePass: ${{ steps.keystore.outputs.keystore_store_password }}
          androidKeyaliasName: ${{ steps.keystore.outputs.keystore_key_alias }}
          androidKeyaliasPass: ${{ steps.keystore.outputs.keystore_key_password }}

      - name: Build Android (release AAB)
        uses: game-ci/unity-builder@v4
        env:
          KEYSTORE_STORE_FILE: ${{ steps.keystore.outputs.keystore_store_file }}
          KEYSTORE_STORE_PASSWORD: ${{ steps.keystore.outputs.keystore_store_password }}
          KEYSTORE_KEY_ALIAS: ${{ steps.keystore.outputs.keystore_key_alias }}
          KEYSTORE_KEY_PASSWORD: ${{ steps.keystore.outputs.keystore_key_password }}
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.AndroidBuild.BuildReleaseAab
          versioning: None
          customParameters: >
            -buildPath Builds/Android/decantra-${{ steps.versioning.outputs.artifact_version }}-android-play.aab
            -versionName ${{ steps.versioning.outputs.version_name }}
            -versionCode ${{ steps.versioning.outputs.version_code }}
          androidKeystoreName: ${{ steps.keystore.outputs.keystore_store_file }}
          androidKeystorePass: ${{ steps.keystore.outputs.keystore_store_password }}
          androidKeyaliasName: ${{ steps.keystore.outputs.keystore_key_alias }}
          androidKeyaliasPass: ${{ steps.keystore.outputs.keystore_key_password }}

      - name: Build Android (debug APK)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_debug_apk == 'true' }}
        uses: game-ci/unity-builder@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: Android
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.AndroidBuild.BuildDebugApk
          versioning: None
          customParameters: >
            -buildPath Builds/Android/Decantra-debug.apk
            -versionName ${{ steps.versioning.outputs.version_name }}
            -versionCode ${{ steps.versioning.outputs.version_code }}

      - uses: actions/upload-artifact@v4
        with:
          name: Decantra-Android
          path: |
            Builds/Android/decantra-*-android.apk
            Builds/Android/decantra-*-android-play.aab

  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    timeout-minutes: 90
    concurrency:
      group: unity-macos-${{ github.repository }}-${{ github.ref }}
      cancel-in-progress: false
    needs: [check-license, test, solvability]
    if: |
      needs.check-license.outputs.is_unity_license_set == 'true' &&
      needs.test.result == 'success' &&
      needs.solvability.result == 'success' &&
      (
        github.event_name == 'push' ||
        github.event_name == 'release' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.run_ios_build == 'true')
      )
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-ios-${{ hashFiles('Packages/manifest.json', 'Packages/packages-lock.json') }}

      - name: Resolve artifact versioning
        id: versioning
        run: |
          set -euo pipefail
          git fetch --tags --force --prune --prune-tags || true

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            artifact_version="${GITHUB_REF_NAME}"
          else
            base_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
            if [[ -z "${base_tag}" ]]; then
              base_tag="0.0.0"
            fi

            short_sha="$(git rev-parse --short=8 HEAD)"
            artifact_version="${base_tag}-${short_sha}"
          fi

          if [[ -z "${artifact_version}" ]]; then
            artifact_version="0.0.0"
          fi

          echo "ARTIFACT_VERSION=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_NAME=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_CODE=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"
          echo "artifact_version=${artifact_version}" >> "$GITHUB_OUTPUT"
          echo "version_name=${artifact_version}" >> "$GITHUB_OUTPUT"
          echo "version_code=${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"

          echo "Resolved ARTIFACT_VERSION=${artifact_version}"

      - name: Export Unity iOS device Xcode project
        uses: game-ci/unity-builder@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: iOS
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.IosBuild.BuildDeviceXcodeProject
          versioning: None
          customParameters: >
            -buildPath Builds/iOS/Xcode
            -iosMinVersion 15.0

      - name: Build iOS app and package IPA
        run: |
          set -euo pipefail
          mkdir -p Builds/iOS/logs
          mkdir -p Builds/iOS/archive
          mkdir -p Builds/iOS/output

          xcodebuild \
            -project Builds/iOS/Xcode/Unity-iPhone.xcodeproj \
            -scheme Unity-iPhone \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath Builds/iOS/archive/Cantra.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            archive | tee Builds/iOS/logs/xcodebuild-archive.log

          APP_PATH="$(find Builds/iOS/archive/Cantra.xcarchive/Products/Applications -type d -name '*.app' | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app found in iOS archive output" >&2
            exit 1
          fi

          rm -rf Builds/iOS/output/Payload
          mkdir -p Builds/iOS/output/Payload
          cp -R "${APP_PATH}" Builds/iOS/output/Payload/

          IPA_NAME="decantra-${ARTIFACT_VERSION}-ios.ipa"
          (
            cd Builds/iOS/output
            zip -qry "${IPA_NAME}" Payload
          )

      - uses: actions/upload-artifact@v4
        with:
          name: Decantra-iOS
          path: |
            Builds/iOS/output/decantra-*-ios.ipa
            Builds/iOS/logs/**

  # ============================================================================
  # Release
  # ============================================================================
  release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ github.token }}
      PLAY_PACKAGE_NAME: uk.gleissner.decantra
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: Decantra-Android
          path: release-artifacts/android

      - uses: actions/download-artifact@v4
        with:
          name: Decantra-iOS
          path: release-artifacts/ios

      - name: Verify repository checkout
        run: |
          if ! git rev-parse --show-toplevel > /dev/null 2>&1; then
            echo "::error::repository checkout missing in this job - cannot generate release notes or publish release assets"
            exit 1
          fi
          echo "Repository root: $(git rev-parse --show-toplevel)"
          echo "HEAD: $(git describe --tags --always)"

      - name: Publish GitHub release (with retry)
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          mapfile -t FILES < <(find release-artifacts -type f | sort)
          echo "Artifacts to publish (${#FILES[@]}): ${FILES[*]}"

          published=false
          for attempt in 1 2 3; do
            echo "Attempt ${attempt}/3: publishing GitHub release for tag ${TAG}..."
            if gh release view "${TAG}" > /dev/null 2>&1; then
              echo "Release ${TAG} already exists â€” uploading/overwriting artifacts..."
              if gh release upload "${TAG}" "${FILES[@]}" --clobber; then
                published=true
                break
              fi
            else
              if gh release create "${TAG}" \
                  --title "${TAG}" \
                  --generate-notes \
                  "${FILES[@]}"; then
                published=true
                break
              fi
            fi
            if [[ ${attempt} -lt 3 ]]; then
              backoff=$((15 * (2 ** (attempt - 1))))
              echo "Attempt ${attempt} failed. Retrying in ${backoff}s..."
              sleep "${backoff}"
            fi
          done

          if [[ "${published}" != "true" ]]; then
            echo "::error::GitHub release publishing failed after 3 attempts."
            exit 1
          fi
          echo "GitHub release for ${TAG} published successfully."

      - name: Upload AAB to Google Play
        id: play_upload
        continue-on-error: true
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ env.PLAY_PACKAGE_NAME }}
          releaseFiles: release-artifacts/android/*.aab
          track: internal
          status: draft

      - name: Report Google Play upload outcome
        if: always()
        run: |
          if [[ "${{ steps.play_upload.outcome }}" == "failure" ]]; then
            echo "::warning::Google Play upload failed. Artifacts remain attached to the GitHub release."
          elif [[ "${{ steps.play_upload.outcome }}" == "skipped" ]]; then
            echo "::notice::Google Play upload was skipped."
          else
            echo "Google Play upload completed successfully."
          fi
