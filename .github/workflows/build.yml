name: Build Decantra

on:
    push:
        branches: ["**"]
        tags: ["v*", "*.*.*"]
    pull_request:

jobs:
    test:
        name: Unity tests (EditMode + PlayMode)
        runs-on: ubuntu-latest
        env:
            UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true
            - uses: actions/cache@v4
              with:
                  path: Library
                  key: Library-${{ runner.os }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
                  restore-keys: |
                      Library-${{ runner.os }}-
            - uses: game-ci/unity-test-runner@v4
              with:
                  projectPath: .
                  unityVersion: 6000.3.5f2
                  testMode: editmode
                  artifactsPath: TestResults
            - uses: game-ci/unity-test-runner@v4
              with:
                  projectPath: .
                  unityVersion: 6000.3.5f2
                  testMode: playmode
                  artifactsPath: TestResults

    build-android:
        name: Build Android APK
        runs-on: ubuntu-latest
        needs: test
        env:
            UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true
            - uses: actions/cache@v4
              with:
                  path: Library
                  key: Library-${{ runner.os }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
                  restore-keys: |
                      Library-${{ runner.os }}-
            - name: Select versioning strategy
              run: |
                  if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
                      echo "VERSIONING=Tag" >> "$GITHUB_ENV"
                  else
                      echo "VERSIONING=Semantic" >> "$GITHUB_ENV"
                  fi
            - uses: game-ci/unity-builder@v4
              id: build_release
              env:
                  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
                  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
                  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
              with:
                  projectPath: .
                  unityVersion: 6000.3.5f2
                  targetPlatform: Android
                  buildMethod: Decantra.App.Editor.AndroidBuild.BuildReleaseApk
                  versioning: ${{ env.VERSIONING }}
                  customParameters: -buildPath Builds/Android/Decantra-release.apk
                  androidExportType: androidPackage
                  buildsPath: Builds/Android
            - uses: game-ci/unity-builder@v4
              id: build_debug
              env:
                  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
                  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
                  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
              with:
                  projectPath: .
                  unityVersion: 6000.3.5f2
                  targetPlatform: Android
                  buildMethod: Decantra.App.Editor.AndroidBuild.BuildDebugApk
                  versioning: ${{ env.VERSIONING }}
                  customParameters: -buildPath Builds/Android/Decantra-debug.apk
                  androidExportType: androidPackage
                  androidVersionCode: ${{ steps.build_release.outputs.androidVersionCode }}
                  buildsPath: Builds/Android
            - name: Rename APKs with version
              run: |
                  version="${{ steps.build_release.outputs.buildVersion }}"
                  if [[ -z "$version" ]]; then
                      echo "Missing buildVersion from unity-builder." >&2
                      exit 1
                  fi
                  mv Builds/Android/Decantra-release.apk "Builds/Android/decantra-${version}.apk"
                  mv Builds/Android/Decantra-debug.apk "Builds/Android/decantra-${version}-debug.apk"
            - uses: actions/upload-artifact@v4
              with:
                  name: Decantra-Android-Release
                                    path: Builds/Android/decantra-${{ steps.build_release.outputs.buildVersion }}.apk
            - uses: actions/upload-artifact@v4
              with:
                  name: Decantra-Android-Debug
                                    path: Builds/Android/decantra-${{ steps.build_release.outputs.buildVersion }}-debug.apk

    release:
        name: Create GitHub release
        runs-on: ubuntu-latest
        needs: build-android
        if: startsWith(github.ref, 'refs/tags/')
        permissions:
            contents: write
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: Decantra-Android-Release
                  path: release-artifacts
            - uses: actions/download-artifact@v4
              with:
                  name: Decantra-Android-Debug
                  path: release-artifacts
            - name: Publish release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      release-artifacts/decantra-*.apk
