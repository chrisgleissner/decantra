name: iOS Build + Maestro

on:
  push:
    branches:
      - "**"
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    paths-ignore:
      - "**.md"
      - "doc/**"
      - "docs/**"
      - "LICENSE"
      - ".gitignore"
  workflow_dispatch:

concurrency:
  group: ios-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  UNITY_VERSION: "6000.3.5f2"
  IOS_BUNDLE_ID: uk.gleissner.decantra

jobs:
  check-license:
    name: Check Unity license secrets
    runs-on: ubuntu-latest
    outputs:
      is_unity_license_set: ${{ steps.check.outputs.is_unity_license_set }}
    steps:
      - name: Detect Unity license secrets
        id: check
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        run: |
          if [[ -n "${UNITY_LICENSE}" && -n "${UNITY_EMAIL}" && -n "${UNITY_PASSWORD}" ]]; then
            echo "is_unity_license_set=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_unity_license_set=false" >> "$GITHUB_OUTPUT"
            echo "Unity license secrets are missing."
          fi

  build-ios-simulator:
    name: Build iOS simulator app
    runs-on: macos-latest
    timeout-minutes: 90
    needs: check-license
    if: needs.check-license.outputs.is_unity_license_set == 'true'
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Resolve artifact versioning
        id: versioning
        run: |
          set -euo pipefail
          git fetch --tags --force --prune --prune-tags || true

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            artifact_version="${GITHUB_REF_NAME}"
          else
            base_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
            if [[ -z "${base_tag}" ]]; then
              base_tag="0.0.0"
            fi

            short_sha="$(git rev-parse --short=8 HEAD)"
            artifact_version="${base_tag}-${short_sha}"
          fi

          if [[ -z "${artifact_version}" ]]; then
            artifact_version="0.0.0"
          fi

          echo "ARTIFACT_VERSION=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_NAME=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_CODE=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"
          echo "artifact_version=${artifact_version}" >> "$GITHUB_OUTPUT"

      - uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-ios-${{ hashFiles('Packages/manifest.json', 'Packages/packages-lock.json') }}

      - name: Export Unity iOS Xcode project
        uses: game-ci/unity-builder@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: iOS
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.IosBuild.BuildSimulatorXcodeProject
          versioning: None
          customParameters: >
            -buildPath Builds/iOS/Xcode
            -iosMinVersion 15.0

      - name: Build simulator app with Xcode
        run: |
          set -euo pipefail
          mkdir -p Builds/iOS/logs

          xcodebuild \
            -project Builds/iOS/Xcode/Unity-iPhone.xcodeproj \
            -scheme Unity-iPhone \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "generic/platform=iOS Simulator" \
            -derivedDataPath Builds/iOS/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            | tee Builds/iOS/logs/xcodebuild.log

          APP_PATH="$(find Builds/iOS/DerivedData/Build/Products -type d -name '*.app' | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No simulator .app artifact found" >&2
            exit 1
          fi

          mkdir -p Builds/iOS/SimulatorApp
          rm -rf Builds/iOS/SimulatorApp/Cantra.app
          cp -R "${APP_PATH}" Builds/iOS/SimulatorApp/Cantra.app

          APP_SIZE_BYTES="$(du -sb Builds/iOS/SimulatorApp/Cantra.app | awk '{print $1}')"
          if [[ "${APP_SIZE_BYTES}" -lt 1000000 ]]; then
            echo "Simulator app size is implausibly small: ${APP_SIZE_BYTES} bytes" >&2
            exit 1
          fi

      - name: Upload iOS simulator app
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-app
          path: Builds/iOS/SimulatorApp/Cantra.app
          if-no-files-found: error
          retention-days: 14

      - name: Upload iOS simulator Xcode project + logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build-artifacts
          path: |
            Builds/iOS/Xcode/**
            Builds/iOS/logs/**
          if-no-files-found: warn
          retention-days: 14

  build-ios-ipa:
    name: Build iOS IPA
    runs-on: macos-latest
    timeout-minutes: 90
    needs: check-license
    if: needs.check-license.outputs.is_unity_license_set == 'true'
    env:
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ runner.os }}-${{ env.UNITY_VERSION }}-ios-${{ hashFiles('Packages/manifest.json', 'Packages/packages-lock.json') }}

      - name: Resolve artifact versioning
        id: versioning
        run: |
          set -euo pipefail
          git fetch --tags --force --prune --prune-tags || true

          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            artifact_version="${GITHUB_REF_NAME}"
          else
            base_tag="$(git describe --tags --abbrev=0 2>/dev/null || true)"
            if [[ -z "${base_tag}" ]]; then
              base_tag="0.0.0"
            fi

            short_sha="$(git rev-parse --short=8 HEAD)"
            artifact_version="${base_tag}-${short_sha}"
          fi

          if [[ -z "${artifact_version}" ]]; then
            artifact_version="0.0.0"
          fi

          echo "ARTIFACT_VERSION=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_NAME=${artifact_version}" >> "$GITHUB_ENV"
          echo "VERSION_CODE=${GITHUB_RUN_NUMBER}" >> "$GITHUB_ENV"
          echo "artifact_version=${artifact_version}" >> "$GITHUB_OUTPUT"

      - name: Export Unity iOS device Xcode project
        uses: game-ci/unity-builder@v4
        with:
          projectPath: .
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: iOS
          buildsPath: Builds
          buildMethod: Decantra.App.Editor.IosBuild.BuildDeviceXcodeProject
          versioning: None
          customParameters: >
            -buildPath Builds/iOS/XcodeDevice
            -iosMinVersion 15.0

      - name: Build archive and package IPA
        run: |
          set -euo pipefail
          mkdir -p Builds/iOS/logs
          mkdir -p Builds/iOS/archive
          mkdir -p Builds/iOS/output

          xcodebuild \
            -project Builds/iOS/XcodeDevice/Unity-iPhone.xcodeproj \
            -scheme Unity-iPhone \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            -archivePath Builds/iOS/archive/Cantra.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            archive | tee Builds/iOS/logs/xcodebuild-archive.log

          APP_PATH="$(find Builds/iOS/archive/Cantra.xcarchive/Products/Applications -type d -name '*.app' | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app found in iOS archive output" >&2
            exit 1
          fi

          rm -rf Builds/iOS/output/Payload
          mkdir -p Builds/iOS/output/Payload
          cp -R "${APP_PATH}" Builds/iOS/output/Payload/

          IPA_NAME="decantra-${ARTIFACT_VERSION}-ios.ipa"
          (
            cd Builds/iOS/output
            zip -qry "${IPA_NAME}" Payload
          )

          IPA_PATH="Builds/iOS/output/${IPA_NAME}"
          if [[ ! -f "${IPA_PATH}" ]]; then
            echo "IPA artifact was not created" >&2
            exit 1
          fi

          IPA_SIZE_BYTES="$(du -sb "${IPA_PATH}" | awk '{print $1}')"
          if [[ "${IPA_SIZE_BYTES}" -lt 1000000 ]]; then
            echo "IPA size is implausibly small: ${IPA_SIZE_BYTES} bytes" >&2
            exit 1
          fi

      - name: Upload iOS IPA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-artifacts
          path: |
            Builds/iOS/output/decantra-*-ios.ipa
            Builds/iOS/logs/**
          if-no-files-found: error
          retention-days: 14

      - name: Upload iOS device Xcode project + logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-device-build-artifacts
          path: |
            Builds/iOS/XcodeDevice/**
            Builds/iOS/logs/**
          if-no-files-found: warn
          retention-days: 14

  maestro-ios:
    name: Maestro iOS simulator tests
    runs-on: macos-latest
    timeout-minutes: 45
    needs: build-ios-simulator
    steps:
      - uses: actions/checkout@v4

      - name: Download simulator app
        uses: actions/download-artifact@v4
        with:
          name: ios-simulator-app
          path: Builds/iOS/SimulatorApp

      - name: Cache Maestro CLI
        uses: actions/cache@v4
        with:
          path: ~/.maestro
          key: maestro-cli-${{ runner.os }}-v1

      - name: Install Maestro CLI
        run: |
          set -euo pipefail
          if [[ -x "$HOME/.maestro/bin/maestro" ]]; then
            "$HOME/.maestro/bin/maestro" --version
          else
            curl -Ls "https://get.maestro.mobile.dev" | bash
            "$HOME/.maestro/bin/maestro" --version
          fi
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"

      - name: Select and boot simulator
        id: simulator
        run: |
          set -euo pipefail
          python3 <<'PY'
          import json
          import os
          import subprocess
          import sys

          runtimes = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "runtimes", "-j"], text=True)).get("runtimes", [])
          runtime = None
          for major in (18, 17, 16, 15):
              for candidate in runtimes:
                  if not candidate.get("isAvailable", False):
                      continue
                  ident = candidate.get("identifier", "")
                  if not ident.startswith("com.apple.CoreSimulator.SimRuntime.iOS-"):
                      continue
                  try:
                      c_major = int(ident.split("iOS-", 1)[1].split("-")[0])
                  except Exception:
                      continue
                  if c_major == major:
                      runtime = ident
                      break
              if runtime:
                  break

          if runtime is None:
              print("No compatible iOS simulator runtime found", file=sys.stderr)
              sys.exit(1)

          device_types = json.loads(subprocess.check_output(["xcrun", "simctl", "list", "devicetypes", "-j"], text=True)).get("devicetypes", [])
          preferred = ["iPhone 15", "iPhone 14", "iPhone 13"]
          device_type = None
          for name in preferred:
              device_type = next((d for d in device_types if d.get("name") == name and d.get("isAvailable", True)), None)
              if device_type:
                  break

          if device_type is None:
              print("No preferred iPhone simulator device type available", file=sys.stderr)
              sys.exit(1)

          sim_name = f"Cantra-iOS-{os.environ.get('GITHUB_RUN_ID', 'local')}-{os.environ.get('GITHUB_RUN_ATTEMPT', '1')}"
          udid = subprocess.check_output(["xcrun", "simctl", "create", sim_name, device_type["identifier"], runtime], text=True).strip()
          subprocess.check_call(["xcrun", "simctl", "boot", udid])
          subprocess.check_call(["xcrun", "simctl", "bootstatus", udid, "-b"])

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"udid={udid}\n")
              fh.write(f"runtime={runtime}\n")
              fh.write(f"device_type={device_type['identifier']}\n")
          PY

      - name: Install app
        run: |
          set -euo pipefail
          APP_PATH="Builds/iOS/SimulatorApp/Cantra.app"
          xcrun simctl install "${{ steps.simulator.outputs.udid }}" "${APP_PATH}"

      - name: Run Maestro smoke flow
        env:
          MAESTRO_CLI_NO_ANALYTICS: 1
          MAESTRO_DRIVER_STARTUP_TIMEOUT: "420000"
        run: |
          set -euo pipefail
          mkdir -p test-results/maestro
          maestro --device "${{ steps.simulator.outputs.udid }}" test .maestro/ios-cantra-smoke.yaml | tee test-results/maestro/maestro.log

      - name: Upload Maestro artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-maestro-artifacts
          path: |
            test-results/maestro/**
            ~/.maestro/tests/**
          if-no-files-found: warn
          retention-days: 14

      - name: Shutdown simulator
        if: always()
        run: |
          set -euo pipefail
          xcrun simctl shutdown "${{ steps.simulator.outputs.udid }}" || true
          xcrun simctl delete "${{ steps.simulator.outputs.udid }}" || true
