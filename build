#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APK_DEFAULT="${ROOT_DIR}/Builds/Android/Decantra.apk"
DECANTRA_ADB_SERVER_PORT="${DECANTRA_ADB_SERVER_PORT:-5039}"
DECANTRA_ANDROID_SERIAL="${DECANTRA_ANDROID_SERIAL:-${ANDROID_SERIAL:-}}"
UNITY_PATH_OVERRIDE="${UNITY_PATH:-}"

export ADB_SERVER_PORT="${DECANTRA_ADB_SERVER_PORT}"

RUN_TESTS=true
RUN_BUILD=true
RUN_INSTALL=false
BUILD_VARIANT="release"
CAPTURE_SCREENSHOTS=false
SCREENSHOTS_ONLY=false
GENERATE_SOLUTIONS=false

AUTO_REINSTALL=false
APP_ID="uk.gleissner.decantra"

DEVICE_ID=""
APK_PATH=""

APT_UPDATED=false

usage() {
  cat <<'EOF'
Decantra - Android Build Script

Usage: ./build [OPTIONS]

Options:
  --install            Install APK to first connected Android device (via adb)
  --reinstall          Uninstall existing app before installing
  --device <id>        Specific device ID for adb (optional)
  --adb-port <port>    ADB server port for Decantra (default: 5039)
  --serial <id>        Device serial to target (env: DECANTRA_ANDROID_SERIAL)
  --apk-path <path>    APK path to install (default: Builds/Android/Decantra.apk)
  --skip-tests         Skip Unity tests
  --skip-build         Skip APK build
  --debug              Build the debug APK (default: release)
  --screenshots        Capture Play Store screenshots after build
  --screenshots-only   Capture screenshots only (skip tests/build/install)
  --generate-solutions Regenerate solver-solutions-debug.txt (requires dotnet)
  -h, --help           Show this help message

Examples:
  ./build                         Run tests and build release APK
  ./build --debug                 Run tests and build debug APK
  ./build --skip-tests            Build release APK without running tests
  ./build --skip-build --install  Install existing APK to device
  ./build --install --reinstall   Uninstall and reinstall the APK
  ./build --install --device <id> Build and install to a specific device
  ./build --screenshots           Build + capture Play Store screenshots
  ./build --screenshots-only      Capture screenshots from an existing APK
  ./build --generate-solutions    Regenerate solver solutions file
EOF
}

log() {
  printf "\n==> %s\n" "$1"
}

have_cmd() {
  command -v "$1" >/dev/null 2>&1
}

find_adb_device() {
  # Prefer emulator over physical devices for reliable testing
  local emulator_device
  emulator_device="$(adb devices | awk 'NR>1 && $2=="device" && $1 ~ /^emulator/ {print $1; exit}')"
  if [[ -n "${emulator_device}" ]]; then
    echo "${emulator_device}"
    return
  fi
  # Fall back to first available device
  adb devices | awk 'NR>1 && $2=="device" {print $1; exit}'
}

ensure_adb_daemon() {
  local attempt=1
  local max_attempts=4
  local adb_log="/tmp/adb.${UID}.log"
  local inotify_limit=""
  local desired_inotify=512

  if ! have_cmd adb; then
    echo "adb not found in PATH" >&2
    return 1
  fi

  inotify_limit="$(cat /proc/sys/fs/inotify/max_user_instances 2>/dev/null || echo "")"
  if [[ -n "${inotify_limit}" && "${inotify_limit}" -lt ${desired_inotify} ]]; then
    if have_cmd sudo; then
      sudo sysctl -w "fs.inotify.max_user_instances=${desired_inotify}" >/dev/null 2>&1 || true
    fi
  fi

  while [[ ${attempt} -le ${max_attempts} ]]; do
    ulimit -n 8192 >/dev/null 2>&1 || true
    adb kill-server >/dev/null 2>&1 || true
    pkill -f "[a]db" >/dev/null 2>&1 || true
    rm -f "${adb_log}" >/dev/null 2>&1 || true
    adb start-server >/dev/null 2>&1 || true
    sleep 0.6

    if adb devices >/dev/null 2>&1; then
      return 0
    fi

    echo "adb daemon failed to start (attempt ${attempt}/${max_attempts})." >&2
    if [[ -f "${adb_log}" ]]; then
      tail -n 5 "${adb_log}" >&2 || true
    fi
    attempt=$((attempt + 1))
    sleep 0.8
  done

  echo "adb daemon failed to start after ${max_attempts} attempts." >&2
  if [[ -f "${adb_log}" ]]; then
    tail -n 20 "${adb_log}" >&2 || true
  fi
  return 1
}

run_with_sudo_if_needed() {
  if [[ ${EUID:-0} -ne 0 ]]; then
    if have_cmd sudo; then
      sudo "$@"
      return
    fi

    echo "Missing sudo for installing dependencies." >&2
    return 1
  fi

  "$@"
}

apt_install_once() {
  local pkg="$1"

  if ! have_cmd apt-get; then
    echo "apt-get not available to install ${pkg}. Install it manually." >&2
    return 1
  fi

  if [[ "${APT_UPDATED}" == "false" ]]; then
    run_with_sudo_if_needed apt-get update -y
    APT_UPDATED=true
  fi

  run_with_sudo_if_needed apt-get install -y "${pkg}"
}

ensure_command() {
  local cmd="$1"
  local pkg="$2"

  if have_cmd "${cmd}"; then
    return 0
  fi

  log "Installing missing dependency: ${cmd}"
  apt_install_once "${pkg}"

  if ! have_cmd "${cmd}"; then
    echo "Dependency still missing: ${cmd}" >&2
    return 1
  fi
}

is_writable_dir() {
  local path="$1"
  [[ -n "${path}" && -d "${path}" && -w "${path}" ]]
}

run_sdkmanager() {
  local sdk_root="$1"
  local java_home="$2"
  local component="$3"

  if is_writable_dir "${sdk_root}"; then
    env ANDROID_SDK_ROOT="${sdk_root}" ANDROID_HOME="${sdk_root}" JAVA_HOME="${java_home}" \
      bash -c "yes | sdkmanager --sdk_root='${sdk_root}' '${component}'"
  else
    run_with_sudo_if_needed env ANDROID_SDK_ROOT="${sdk_root}" ANDROID_HOME="${sdk_root}" JAVA_HOME="${java_home}" \
      bash -c "yes | sdkmanager --sdk_root='${sdk_root}' '${component}'"
  fi
}

ensure_sdk_component() {
  local sdk_root="$1"
  local component="$2"
  local marker_dir="$3"
  local java_home="${4:-}"

  if [[ -n "${marker_dir}" && -d "${marker_dir}" ]]; then
    return 0
  fi

  if ! have_cmd sdkmanager; then
    echo "sdkmanager not found. Cannot install ${component}." >&2
    return 1
  fi

  log "Installing ${component} via sdkmanager"
  run_sdkmanager "${sdk_root}" "${java_home}" "${component}"
}

ensure_cmdline_tools_latest() {
  local sdk_root="$1"
  local version="$2"
  local target_dir="${sdk_root}/cmdline-tools/${version}"
  local latest_link="${sdk_root}/cmdline-tools/latest"

  if [[ ! -d "${target_dir}" ]]; then
    return 0
  fi

  if is_writable_dir "${sdk_root}/cmdline-tools"; then
    ln -sfn "${target_dir}" "${latest_link}"
  else
    run_with_sudo_if_needed ln -sfn "${target_dir}" "${latest_link}"
  fi
}

ensure_ndk_version() {
  local sdk_root="$1"
  local version="$2"
  local java_home="${3:-}"
  local ndk_dir="${sdk_root}/ndk/${version}"

  if [[ -d "${ndk_dir}" ]]; then
    echo "${ndk_dir}"
    return 0
  fi

  if ! have_cmd sdkmanager; then
    echo "sdkmanager not found. Cannot install NDK ${version}." >&2
    return 1
  fi

  log "Installing Android NDK ${version} via sdkmanager"
  run_sdkmanager "${sdk_root}" "${java_home}" "ndk;${version}"
  if is_writable_dir "${sdk_root}"; then
    env ANDROID_SDK_ROOT="${sdk_root}" ANDROID_HOME="${sdk_root}" JAVA_HOME="${java_home}" \
      bash -c "yes | sdkmanager --sdk_root='${sdk_root}' --licenses" || true
  else
    run_with_sudo_if_needed env ANDROID_SDK_ROOT="${sdk_root}" ANDROID_HOME="${sdk_root}" JAVA_HOME="${java_home}" \
      bash -c "yes | sdkmanager --sdk_root='${sdk_root}' --licenses" || true
  fi

  if [[ -d "${ndk_dir}" ]]; then
    echo "${ndk_dir}"
    return 0
  fi

  echo "Failed to install NDK ${version} to ${ndk_dir}." >&2
  return 1
}

detect_java_home() {
  if [[ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]]; then
    echo "/usr/lib/jvm/java-17-openjdk-amd64"
    return 0
  fi

  if [[ -d "/usr/lib/jvm/java-11-openjdk-amd64" ]]; then
    echo "/usr/lib/jvm/java-11-openjdk-amd64"
    return 0
  fi

  local javac_path=""
  javac_path="$(command -v javac 2>/dev/null || true)"
  if [[ -n "${javac_path}" ]]; then
    readlink -f "${javac_path}" | sed 's:/bin/javac$::'
    return 0
  fi

  return 1
}

ensure_jdk_17() {
  if [[ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]]; then
    echo "/usr/lib/jvm/java-17-openjdk-amd64"
    return 0
  fi

  apt_install_once openjdk-17-jdk

  if [[ -d "/usr/lib/jvm/java-17-openjdk-amd64" ]]; then
    echo "/usr/lib/jvm/java-17-openjdk-amd64"
    return 0
  fi

  return 1
}

detect_android_sdk_root() {
  local candidate=""
  for candidate in \
    "${ANDROID_SDK_ROOT:-}" \
    "${ANDROID_HOME:-}" \
    "${HOME}/Android/Sdk" \
    "/usr/lib/android-sdk" \
    "/opt/android-sdk" \
    "/usr/local/android-sdk"; do
    if [[ -n "${candidate}" && -d "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
  done

  return 1
}

detect_android_ndk_root() {
  local candidate=""

  if [[ -n "${ANDROID_NDK_ROOT:-}" && -d "${ANDROID_NDK_ROOT}" ]]; then
    echo "${ANDROID_NDK_ROOT}"
    return 0
  fi

  for candidate in /usr/lib/android-ndk* /opt/android-ndk* /usr/local/android-ndk*; do
    if [[ -d "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
  done

  if [[ -d "/usr/lib/android-sdk/ndk" ]]; then
    if [[ -d "/usr/lib/android-sdk/ndk/27.2.12479018" ]]; then
      echo "/usr/lib/android-sdk/ndk/27.2.12479018"
      return 0
    fi

    candidate=$(ls -d /usr/lib/android-sdk/ndk/* 2>/dev/null | sort -V | tail -n 1 || true)
    if [[ -n "${candidate}" && -d "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
  fi

  return 1
}

ensure_android_toolchain() {
  local unity_path="$1"
  local editor_dir=""
  local embedded_ndk=""
  local embedded_clang=""
  local sdk_root_pre=""
  local required_ndk="27.2.12479018"

  editor_dir="$(cd "$(dirname "${unity_path}")" && pwd)"
  embedded_ndk="${editor_dir}/Data/PlaybackEngines/AndroidPlayer/NDK"
  embedded_clang="${embedded_ndk}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++"

  if [[ -x "${embedded_clang}" ]]; then
    return 0
  fi

  log "Android NDK not found in Unity. Installing external Android toolchain."

  local ensured_java_home=""
  ensured_java_home="$(ensure_jdk_17 || true)"

  sdk_root_pre="$(detect_android_sdk_root || true)"
  if [[ -n "${sdk_root_pre}" && -d "${sdk_root_pre}/ndk/${required_ndk}" && -d "${sdk_root_pre}/platform-tools" && -d "${sdk_root_pre}/build-tools/35.0.0" && -d "${sdk_root_pre}/cmdline-tools/16.0" ]]; then
    log "Android SDK/NDK already installed at ${sdk_root_pre}. Skipping apt installs."
  else
    if ! have_cmd adb; then
      if dpkg -s google-android-platform-tools-installer >/dev/null 2>&1; then
        apt_install_once google-android-platform-tools-installer
      else
        apt_install_once android-sdk-platform-tools
      fi
    fi

    if dpkg -s google-android-platform-tools-installer >/dev/null 2>&1; then
      apt_install_once google-android-cmdline-tools-13.0-installer
      apt_install_once google-android-ndk-r25c-installer
    else
      apt_install_once android-sdk
      apt_install_once android-sdk-build-tools
      apt_install_once android-sdk-platforms
      apt_install_once android-sdk-platform-tools
    fi
  fi

  local sdk_root=""
  local ndk_root=""
  local java_home=""

  sdk_root="$(detect_android_sdk_root || true)"
  java_home="${ensured_java_home}"
  if [[ -z "${java_home}" ]]; then
    java_home="$(detect_java_home || true)"
  fi

  if [[ -z "${sdk_root}" ]]; then
    sdk_root="${HOME}/Android/Sdk"
    mkdir -p "${sdk_root}"
  fi

  ndk_root="$(detect_android_ndk_root || true)"

  if [[ -n "${sdk_root}" ]]; then
    local required_ndk="27.2.12479018"
    local ensured_ndk=""
    ensured_ndk="$(ensure_ndk_version "${sdk_root}" "${required_ndk}" "${java_home}" || true)"
    if [[ -n "${ensured_ndk}" ]]; then
      ndk_root="${ensured_ndk}"
    fi

    ensure_sdk_component "${sdk_root}" "cmake;3.22.1" "${sdk_root}/cmake/3.22.1" "${java_home}" || true
    ensure_sdk_component "${sdk_root}" "cmdline-tools;16.0" "${sdk_root}/cmdline-tools/16.0" "${java_home}" || true
    ensure_cmdline_tools_latest "${sdk_root}" "16.0" || true
    ensure_sdk_component "${sdk_root}" "platform-tools" "${sdk_root}/platform-tools" "${java_home}" || true
    ensure_sdk_component "${sdk_root}" "build-tools;35.0.0" "${sdk_root}/build-tools/35.0.0" "${java_home}" || true
    ensure_sdk_component "${sdk_root}" "platforms;android-35" "${sdk_root}/platforms/android-35" "${java_home}" || true
  fi

  if [[ -z "${sdk_root}" || -z "${ndk_root}" || -z "${java_home}" ]]; then
    echo "Android toolchain install did not provide required paths." >&2
    echo "Detected ANDROID_SDK_ROOT='${sdk_root}', ANDROID_NDK_ROOT='${ndk_root}', JAVA_HOME='${java_home}'." >&2
    return 1
  fi

  export ANDROID_SDK_ROOT="${sdk_root}"
  export ANDROID_HOME="${sdk_root}"
  export ANDROID_NDK_ROOT="${ndk_root}"
  export JAVA_HOME="${java_home}"
  if [[ -d "${ANDROID_SDK_ROOT}/cmdline-tools" ]]; then
    local cmdline_dir=""
    cmdline_dir=$(ls -d "${ANDROID_SDK_ROOT}/cmdline-tools"/*/bin 2>/dev/null | sort -V | tail -n 1 || true)
    if [[ -n "${cmdline_dir}" ]]; then
      export PATH="${cmdline_dir}:${PATH}"
    fi
  fi

  export PATH="${JAVA_HOME}/bin:${PATH}"

  return 0
}

discover_unity_path() {
  local candidate=""

  if [[ -n "${UNITY_PATH_OVERRIDE}" ]]; then
    if [[ -x "${UNITY_PATH_OVERRIDE}" ]]; then
      echo "${UNITY_PATH_OVERRIDE}"
      return 0
    fi

    if have_cmd "${UNITY_PATH_OVERRIDE}"; then
      command -v "${UNITY_PATH_OVERRIDE}"
      return 0
    fi
  fi

  if have_cmd Unity; then
    command -v Unity
    return 0
  fi

  if have_cmd unity; then
    command -v unity
    return 0
  fi

  candidate=$(ls -d "${HOME}/Unity/Hub/Editor"/*/Editor/Unity 2>/dev/null | sort -V | tail -n 1 || true)
  if [[ -n "${candidate}" && -x "${candidate}" ]]; then
    echo "${candidate}"
    return 0
  fi

  candidate=$(ls -d "/opt/Unity/Hub/Editor"/*/Editor/Unity 2>/dev/null | sort -V | tail -n 1 || true)
  if [[ -n "${candidate}" && -x "${candidate}" ]]; then
    echo "${candidate}"
    return 0
  fi

  for candidate in \
    "/opt/unity/Editor/Unity" \
    "/opt/Unity/Editor/Unity" \
    "/usr/local/Unity/Editor/Unity"; do
    if [[ -x "${candidate}" ]]; then
      echo "${candidate}"
      return 0
    fi
  done

  return 1
}

check_unity_lockfile() {
  local lock_file="${ROOT_DIR}/Library/UnityLockfile"
  if [[ -f "${lock_file}" ]]; then
    if [[ -s "${lock_file}" ]]; then
      echo "Unity appears to be running (lockfile present). Close Unity and retry." >&2
      return 1
    fi
  fi
  return 0
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --install)
      RUN_INSTALL=true
      shift
      ;;
    --device)
      DEVICE_ID="${2:-}"
      shift 2
      ;;
    --adb-port)
      DECANTRA_ADB_SERVER_PORT="${2:-}"
      export ADB_SERVER_PORT="${DECANTRA_ADB_SERVER_PORT}"
      shift 2
      ;;
    --serial)
      DECANTRA_ANDROID_SERIAL="${2:-}"
      shift 2
      ;;
    --apk-path)
      APK_PATH="${2:-}"
      shift 2
      ;;
    --skip-tests)
      RUN_TESTS=false
      shift
      ;;
    --skip-build)
      RUN_BUILD=false
      shift
      ;;
    --reinstall)
      AUTO_REINSTALL=true
      shift
      ;;
    --debug)
      BUILD_VARIANT="debug"
      shift
      ;;
    --screenshots)
      CAPTURE_SCREENSHOTS=true
      shift
      ;;
    --screenshots-only)
      CAPTURE_SCREENSHOTS=true
      SCREENSHOTS_ONLY=true
      RUN_TESTS=false
      RUN_BUILD=false
      RUN_INSTALL=false
      shift
      ;;
    --generate-solutions)
      GENERATE_SOLUTIONS=true
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ "${RUN_TESTS}" == "true" || "${RUN_BUILD}" == "true" ]]; then
  ensure_command timeout coreutils
  ensure_command python3 python3

  UNITY_PATH_FOUND="$(discover_unity_path || true)"
  if [[ -z "${UNITY_PATH_FOUND}" ]]; then
    echo "Unity not found. Install Unity or set UNITY_PATH to the Unity editor executable." >&2
    exit 1
  fi
  export UNITY_PATH="${UNITY_PATH_FOUND}"

  if ! check_unity_lockfile; then
    exit 1
  fi

  if [[ "${RUN_BUILD}" == "true" ]]; then
    ensure_android_toolchain "${UNITY_PATH_FOUND}"
  fi
fi

if [[ "${GENERATE_SOLUTIONS}" == "true" ]]; then
  log "Generating solver solutions"
  if ! have_cmd dotnet; then
    echo "dotnet not found in PATH" >&2
    exit 1
  fi
  if ! dotnet run --project "${ROOT_DIR}/Reproduction/Reproduction.csproj" -- bulk 1000 > "${ROOT_DIR}/solver-solutions-debug.txt"; then
    echo "Warning: Failed to generate solver solutions; dotnet run exited with status $?" >&2
  fi
  
  # Run validation gates on generated solutions
  log "Running solution validation gates"
  
  if [[ -x "${ROOT_DIR}/tools/monotonicity_gate.sh" ]]; then
    "${ROOT_DIR}/tools/monotonicity_gate.sh" || {
      echo "Monotonicity gate failed" >&2
      exit 1
    }
  fi
  
  if [[ -x "${ROOT_DIR}/tools/solvability_gate.sh" ]]; then
    "${ROOT_DIR}/tools/solvability_gate.sh" || {
      echo "Solvability gate failed" >&2
      exit 1
    }
  fi
  
  if [[ -x "${ROOT_DIR}/tools/diversity_gate.sh" ]]; then
    "${ROOT_DIR}/tools/diversity_gate.sh" || {
      echo "Diversity gate failed" >&2
      exit 1
    }
  fi
fi

if [[ "${RUN_TESTS}" == "true" ]]; then
  log "Running Unity tests"
  "${ROOT_DIR}/tools/test.sh"
fi

if [[ "${RUN_BUILD}" == "true" ]]; then
  if [[ "${BUILD_VARIANT}" == "release" ]]; then
    log "Building release APK"
  else
    log "Building debug APK"
  fi
  DECANTRA_BUILD_VARIANT="${BUILD_VARIANT}" "${ROOT_DIR}/tools/build_android.sh"
fi

if [[ "${CAPTURE_SCREENSHOTS}" == "true" ]]; then
  ensure_command adb android-tools-adb
  ensure_adb_daemon
  if [[ -z "${DEVICE_ID}" ]]; then
    DEVICE_ID="$(find_adb_device || true)"
  fi
  if [[ -z "${DEVICE_ID}" ]]; then
    log "No adb devices found. Starting Android emulator."
    "${ROOT_DIR}/tools/android-emulator.sh" --no-prereqs
    ensure_adb_daemon
    DEVICE_ID="$(find_adb_device || true)"
  fi
  APK_PATH="${APK_PATH:-$APK_DEFAULT}"
  log "Capturing Play Store screenshots"
  screenshot_args=("--apk" "${APK_PATH}")
  if [[ -n "${DEVICE_ID}" ]]; then
    screenshot_args+=("--device" "${DEVICE_ID}")
  fi
  if [[ "${SCREENSHOTS_ONLY}" == "true" ]]; then
    screenshot_args+=("--screenshots-only")
  fi
  "${ROOT_DIR}/tools/capture_screenshots.sh" "${screenshot_args[@]}"
fi

if [[ "${RUN_INSTALL}" == "true" ]]; then
  ensure_command adb android-tools-adb
  ensure_adb_daemon
  APK_PATH="${APK_PATH:-$APK_DEFAULT}"

  if [[ ! -f "$APK_PATH" ]]; then
    echo "APK not found: $APK_PATH" >&2
    exit 1
  fi

  if [[ -z "$DEVICE_ID" ]]; then
    DEVICE_ID="${DECANTRA_ANDROID_SERIAL}"
  fi

  if [[ -z "$DEVICE_ID" ]]; then
    DEVICE_ID="$(adb devices | awk 'NR>1 && $2=="device" {print $1; exit}')"
  fi

  if [[ -z "$DEVICE_ID" ]]; then
    echo "No adb devices found. Connect a device or pass --device <id>." >&2
    exit 1
  fi

  log "Installing APK to device: $DEVICE_ID"
  if [[ "${AUTO_REINSTALL}" == "true" ]]; then
    echo "Uninstalling ${APP_ID} before install (per --reinstall)..." >&2
    adb -s "$DEVICE_ID" uninstall "${APP_ID}" >/dev/null 2>&1 || true
  fi

  install_output=""
  install_status=0
  if ! install_output=$(adb -s "$DEVICE_ID" install -r "$APK_PATH" 2>&1); then
    install_status=$?
  fi

  if [[ ${install_status} -ne 0 ]]; then
    echo "APK install failed: ${install_output}" >&2
    exit ${install_status}
  fi

  log "Launching app"
  adb -s "$DEVICE_ID" shell monkey -p "${APP_ID}" -c android.intent.category.LAUNCHER 1
fi

log "Done"